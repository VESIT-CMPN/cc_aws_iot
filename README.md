###### cc_aws_iot

# Creating a Virtual thing on AWS IoT and Developing End-to-End IoT Application.
 
### Problem Defination :

With an increasing trend in the world of IoT and in the concept of smart city , it has become neceessity to handle the data 
generated by smart devices and that too remotely.Data analytics of the data generated by IoT device and device manipulation with 
respect to data becomes much easier with the help of good cloud platform service which supports connecting an ioT device over its 
cloud network. 
      
### Requirement Gathering : 
- Understanding the state of device.
- Required data to change the device's state.
- User should be able to control the device's state with the help of cloud network.
- One good cloud platform with more than 99% up-time.

### Methodology : 
- The first thing to ensure about the decide is that , it should be generating some data and saving it locally.
- Now that the device is saving data locally , to get this data on cloud , we need to register our thing (IoT Device) over the cloud platform. 
- Once the thing is registered over the cloud its uniqueness is maintained with the help of private and public keys obtained by cloud platform.
- Once the uniqueness is maintained i.e. the keys are authenticated , the data generated by the IoT device is saved over the cloud (in JSON format) and the API End points are obtained from where the data can be retrived.

## Architecture : 
![AWS IoT Architecture](/aws_arch.png)

### Which cloud platform service and why ?
The only __IAAS__ which comes to our mind to build this usecase is __Amazon Web Services__ ; It is like the only cloud platform , 
we feel , whose documentation can be easily understood . AWS offers one year of free tire for most of its services , one of which 
includes AWS IoT.
The only product which Aws has for developing and managing connection for any gadget or device (IoT) is AWS IoT.Further AWS IoT's 
rules can helpful for connecting the thing to the services like __AWS Lambda__, __DynamoDB__ , __EC2__ , etc, which can be useful
to store data generated by the thing (IoT Device).

## Implementation :

* Creating the __Thing__ in AWS IoT Console

![Thing_temp_sensor](/Screenshot-2018-4-8AWSIoT.png)

* Creating a __rule__ for the Thing to save the data generated by it. 

___Rule: Invoking a lambda function on MQTT message___

![Thing_rule](/Screenshot-2018-4-8AWSIoT(1).png)

* Connecting with the MQTT Gateway to generate messages (data)

![Thing_mqtt](/Screenshot-2018-4-9AWSIoT.png)

* Creating a function in AWS Lambda and adding triggers to it

![Lambda_fn](/Screenshot-2018-4-9LambdaManagementConsole.png)

* Code that saves MQTT messages(data) in DynamoDB table

```javascript
'use strict';

console.log('Loading function');

const AWS = require('aws-sdk');

const docClient = new AWS.DynamoDB.DocumentClient({region: 'us-east-1'});


exports.handler = (event, context, callback) => {
    console.log('Received event:', JSON.stringify(event, null, 2));
    console.log('value1 =', event.test_data);
    
    var count = 0;
    
    var params = {
        
        Item:{
            id : count.toString() ,
            message : event.test_data.toString(),
        },
        
        TableName : 'consumption'
        
    };
    count++;
    
    docClient.put(params, function(err,data){
        if (err) {
            callback(err,null);
            console.log('Error saving Data!');
        } else {
            callback(null,data);
            console.log('Data Saved!');
        }
        
    });
    
        
    
    // console.log('value2 =', event.key2);
    // console.log('value3 =', event.key3);
    callback(null, event.key1);  // Echo back the first key value
    //callback('Something went wrong');
};

```

* DynamoDB Table

![dynamo](/Screenshot-2018-4-9DynamoDBAWSConsole.png)

* Launching EC2 Instance to Host the Data generated by the Thing.

![ec2](/ec2.png)

* Front-End Code that feteches data from DynamoDB. 

```javascript
var AWS = require("aws-sdk");
var awsConfig = {
    "region": "us-east-1",
    "endpoint": "http://dynamodb.us-east-1.amazonaws.com",
    "accessKeyId": "AFBSFUWVOKVIRHVSRS", "secretAccessKey": "bdsbldbliwvblw/viuviweugvi/fbviaufg"
};
AWS.config.update(awsConfig);

var docClient = new AWS.DynamoDB.DocumentClient();
var fetchOneByKey = function () {
    var params = {
        TableName: "consumption",
        Key: {
            "id": "0"
        }
    };
    docClient.get(params, function (err, data) {
        if (err) {
            console.log("users::fetchOneByKey::error - " + JSON.stringify(err, null, 2));
        }
        else {
            console.log("users::fetchOneByKey::success - " + JSON.stringify(data, null, 2));
        }
    })
}


fetchOneByKey();
```


## CONCLUSION : 
we learnt about different AWS Services like __AWS IoT, Lambda, DynamoDB, EC2,__ WHILE DEVELOPING THE __End-to-End IoT Application__ by creating virtual thing.
